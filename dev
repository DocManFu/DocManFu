#!/usr/bin/env bash
set -euo pipefail

PROJECT_NAME="docmanfu"
COMPOSE_FILE="docker-compose.dev.yml"
DEFAULT_SERVICE="api"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m' # No Color

info()  { echo -e "${BLUE}${BOLD}[info]${NC}  $*"; }
ok()    { echo -e "${GREEN}${BOLD}[ok]${NC}    $*"; }
warn()  { echo -e "${YELLOW}${BOLD}[warn]${NC}  $*"; }
err()   { echo -e "${RED}${BOLD}[error]${NC} $*"; }

compose() {
    docker compose -p "$PROJECT_NAME" -f "$COMPOSE_FILE" "$@"
}

usage() {
    cat <<EOF
${BOLD}DocManFu Development Environment${NC}

${BOLD}Usage:${NC} ./dev <command> [options]

${BOLD}Commands:${NC}
  up, start          Start all containers (default if no command given)
  down, stop         Stop and remove containers
  restart            Restart all containers
  rebuild            Full rebuild with --no-cache
  build              Build images without starting
  logs [service]     Follow container logs (optionally for a specific service)
  ps, status         Show container status
  shell [service]    Open a shell in a container (default: ${DEFAULT_SERVICE})
  clean              Stop containers and remove volumes (with confirmation)
  migrate            Run alembic migrations (alembic upgrade head)
  seed               Load sample data (python scripts/seed_data.py)

${BOLD}Options:${NC}
  -d, --detach       Run containers in the background (for up, restart, rebuild)
  -h, --help         Show this help message

${BOLD}Services:${NC}
  api                FastAPI backend (port 8100)
  worker             Celery background worker
  frontend           Svelte dev server (port 5180)
  db                 PostgreSQL (port 5450)
  redis              Redis (port 6390)

${BOLD}AI (Ollama):${NC}
  Requires Ollama running on the host (uses GPU): brew install ollama && ollama serve
  Worker connects via host.docker.internal:11434. Pull model: ollama pull llama3.2

${BOLD}Examples:${NC}
  ./dev                  Start all services (attached)
  ./dev up -d            Start all services (detached)
  ./dev logs api         Follow API logs
  ./dev shell worker     Open shell in worker container
  ./dev rebuild -d       Rebuild and start detached
EOF
}

cmd_up() {
    local detach=""
    for arg in "$@"; do
        case "$arg" in
            -d|--detach) detach="--detach" ;;
        esac
    done
    info "Starting ${PROJECT_NAME} services..."
    compose up --build $detach
    if [[ -n "$detach" ]]; then
        ok "Services started in background"
        compose ps
    fi
}

cmd_down() {
    warn "Stopping ${PROJECT_NAME} services..."
    compose down
    ok "Services stopped"
}

cmd_restart() {
    local detach=""
    for arg in "$@"; do
        case "$arg" in
            -d|--detach) detach="--detach" ;;
        esac
    done
    warn "Restarting ${PROJECT_NAME} services..."
    compose down
    compose up --build $detach
    if [[ -n "$detach" ]]; then
        ok "Services restarted in background"
        compose ps
    fi
}

cmd_rebuild() {
    local detach=""
    for arg in "$@"; do
        case "$arg" in
            -d|--detach) detach="--detach" ;;
        esac
    done
    warn "Rebuilding ${PROJECT_NAME} with --no-cache..."
    compose build --no-cache
    compose up $detach
    if [[ -n "$detach" ]]; then
        ok "Services rebuilt and started in background"
        compose ps
    fi
}

cmd_build() {
    info "Building ${PROJECT_NAME} images..."
    compose build
    ok "Build complete"
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "$service" ]]; then
        info "Following logs for ${service}..."
        compose logs -f "$service"
    else
        info "Following logs for all services..."
        compose logs -f
    fi
}

cmd_ps() {
    compose ps
}

cmd_shell() {
    local service="${1:-$DEFAULT_SERVICE}"
    info "Opening shell in ${service}..."
    compose exec "$service" sh -c 'command -v bash >/dev/null 2>&1 && exec bash || exec sh'
}

cmd_clean() {
    echo -e "${RED}${BOLD}WARNING: This will stop all containers and delete all volumes (database data, uploads, etc.)${NC}"
    read -r -p "Are you sure? [y/N] " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        err "Cleaning ${PROJECT_NAME}..."
        compose down -v
        ok "Containers stopped and volumes removed"
    else
        info "Cancelled"
    fi
}

cmd_migrate() {
    info "Running database migrations..."
    compose exec api alembic upgrade head
    ok "Migrations complete"
}

cmd_seed() {
    info "Loading sample data..."
    compose exec api python -m scripts.seed_data
    ok "Sample data loaded"
}

# Parse command
COMMAND="${1:-up}"

case "$COMMAND" in
    -h|--help)
        usage
        exit 0
        ;;
    up|start)
        shift || true
        cmd_up "$@"
        ;;
    down|stop)
        cmd_down
        ;;
    restart)
        shift
        cmd_restart "$@"
        ;;
    rebuild)
        shift
        cmd_rebuild "$@"
        ;;
    build)
        cmd_build
        ;;
    logs)
        shift
        cmd_logs "$@"
        ;;
    ps|status)
        cmd_ps
        ;;
    shell)
        shift
        cmd_shell "$@"
        ;;
    clean)
        cmd_clean
        ;;
    migrate)
        cmd_migrate
        ;;
    seed)
        cmd_seed
        ;;
    *)
        err "Unknown command: ${COMMAND}"
        echo
        usage
        exit 1
        ;;
esac
